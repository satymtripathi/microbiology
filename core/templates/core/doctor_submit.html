{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}New Sample Submission{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-primary mb-1">{{ page_title }}</h2>
            <p class="text-muted mb-0">Submit a new sample for microbiology analysis.</p>
        </div>
        <div>
            <a href="{% url 'doctor_reports' %}" class="btn btn-outline-secondary">
                <i class="fa-solid fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>

    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm" role="alert">
        <i class="fa-solid fa-info-circle me-2"></i>{{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
    {% endif %}

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                {% csrf_token %}

                <!-- Card 1: Patient Details -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-bottom py-3">
                        <h5 class="card-title mb-0 text-primary"><i class="fa-solid fa-user-injured me-2"></i>Patient &
                            Clinical Information</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-4">
                                {{ form.patient_id|as_crispy_field }}
                            </div>
                            <div class="col-md-4">
                                {{ form.centre_name|as_crispy_field }}
                            </div>
                            <div class="col-md-4">
                                {{ form.eye|as_crispy_field }}
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-4">
                                {{ form.sample|as_crispy_field }}
                            </div>
                            <div class="col-md-4">
                                {{ form.duration_value|as_crispy_field }}
                            </div>
                            <div class="col-md-4">
                                {{ form.duration_unit|as_crispy_field }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card 2: Medical History -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-bottom py-3">
                        <h5 class="card-title mb-0 text-info"><i class="fa-solid fa-file-medical me-2"></i>Medical
                            History</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="form-check form-switch mb-3">
                            {{ form.on_meds }}
                            <label class="form-check-label fw-bold" for="id_on_meds">Patient is on prior
                                medications?</label>
                        </div>

                        <div id="medicationsSection" class="bg-light p-3 rounded mb-3" style="display: none;">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    {{ form.meds_category|as_crispy_field }}
                                </div>
                                <div class="col-md-6" id="customMedSection" style="display: none;">
                                    {{ form.meds_custom|as_crispy_field }}
                                </div>
                            </div>
                            <small class="text-muted"><i class="fa-solid fa-circle-info me-1"></i>Provide details if
                                available (optional).</small>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                {{ form.impression|as_crispy_field }}
                            </div>
                            <div class="col-md-6">
                                {{ form.stain|as_crispy_field }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card 3: Lab Assignment & Image -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-bottom py-3">
                        <h5 class="card-title mb-0 text-success"><i class="fa-solid fa-microscope me-2"></i>Lab
                            Assignment & Imaging</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-4">
                            {{ form.assigned_to|as_crispy_field }}
                            <div class="form-text">Leave blank to auto-assign to the least busy technician.</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Microscopy Slide Image</label>
                            <div class="input-group">
                                {{ form.image }}
                            </div>
                            <div class="form-text">Upload a clear JPEG or PNG image (Max 5MB).</div>
                        </div>
                    </div>
                </div>

                <!-- Submit Action -->
                <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-5">
                    <a href="{% url 'doctor_reports' %}" class="btn btn-light me-md-2">Cancel</a>
                    <button type="submit" class="btn btn-primary px-5 py-2 fw-bold">
                        <i class="fa-solid fa-paper-plane me-2"></i>Submit Request
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const onMedsCheckbox = document.getElementById('id_on_meds');
        const medicationsSection = document.getElementById('medicationsSection');
        const medsCategorySelect = document.getElementById('id_meds_category');
        const customMedSection = document.getElementById('customMedSection');

        // Ensure checkbox has form-check-input class for Bootstrap switch
        onMedsCheckbox.classList.add('form-check-input');

        function toggleMedications() {
            if (onMedsCheckbox.checked) {
                medicationsSection.style.display = 'block';
                // Add slide down animation class if desired
            } else {
                medicationsSection.style.display = 'none';
                medsCategorySelect.value = '';
                document.getElementById('id_meds_custom').value = '';
                customMedSection.style.display = 'none';
            }
        }

        function toggleCustomMed() {
            if (medsCategorySelect.value === 'Others') {
                customMedSection.style.display = 'block';
            } else {
                customMedSection.style.display = 'none';
            }
        }

        onMedsCheckbox.addEventListener('change', toggleMedications);
        medsCategorySelect.addEventListener('change', toggleCustomMed);

        // Initial state
        toggleMedications();
        toggleCustomMed();
    });
</script>
{% endblock %}